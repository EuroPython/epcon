{% extends "ep19/bs/conversations/user_base.html" %}

{% load crispy_forms_tags %}
{# TODO: different extends #}

{% block breadcrumbs %}
{{ block.super }}
<li class='breadcrumb-item active'><a href='{{ thread.get_user_url }}'>{{ thread.title }}</a></li>
{% endblock breadcrumbs %}

{% block conversations_content %}
<h2>{{ thread.title }}</h2>

<p>Status: <span class="status-bg status-bg-{{ thread.status }}">{{ thread.get_status_display }}</span></p>
started
<strong title="{{ thread.created }}">{{ thread.created|timesince }} ago</strong>, last activity
<em title="{{ thread.last_message_date }}">
    {{ thread.last_message_date|timesince }} ago
</em>

{% if thread.metadata %}
    {% include "ep19/bs/conversations/_thread_metadata_as_table.html" %}
{% endif %}

<hr>

{% for message in thread.user_visible_messages %}
{# TODO: include proper module here #}
<div class='message {% include "ep19/bs/conversations/_message_css_classes.html" %} '>


{{ message.content }}


{% if message.attachments.all %}
<p>
<strong>Attachments!</strong>
{% for at in message.attachments.all %}
<a href='{{ at.file.url }}'>{{ at.file.name }}</a><br>
{% endfor %}
{% endif %}

<br>
by <strong>{{ message.created_by.assopy_user.name }}</strong> <span title="{{ message.created }} -- {{ message.uuid }}">{{ message.created|timesince }} ago</span>
</div>
{% endfor %}

<hr>
<h3>Reply to this thread</h3>
<form method='POST' action=".">
    <input type='hidden' name='{{ ThreadActions.submit_reply_to_thread }}'>
    {% csrf_token %}
    {{ user_reply_form|crispy }}
    <input class="btn btn-primary" type="submit" name="" value="Submit reply">
</form>


<hr>
<h5>Manage this thread</h5>
<form method='POST' action='.'>
    <input type='hidden' name='{{ ThreadActions.submit_thread_management }}'>
    {% csrf_token %}
    {% if thread.status != thread.STATUS.COMPLETED %}
    Is this discsussion already over? If you don't expect any replies, please mark this thread as completed.
    <input class="btn btn-warning" type="submit" name="{{ ThreadActions.complete_thread }}" value="Mark as completed">
    {% endif %}

    {% if thread.status == thread.STATUS.COMPLETED %}
    <input class="btn btn-warning" type="submit" name="{{ ThreadActions.reopen_thread }}" value="Reopen">
    {% endif %}
    <a href='#'>
</form>

{% endblock conversations_content %}
