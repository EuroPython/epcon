{% extends "ep19/cart/base.html" %}

{% block breadcrumbs %}
{{ super() }}
&raquo; <a href='#'>Step 2: Pick which tickets you want</a>
{% endblock %}

{% block content %}
<style type="text/css">
td { border: 1px solid #ddd; padding: 1em }
</style>

<div>
    Which tickets do you want?
</div>

<form method='POST' action='.'>
    {{ csrf_input }}
    <table cellspacing=0>
        {% for fare in available_fares %}
        <tr>
            <td>
                <h3>{{ fare.name }}</h3>
                <p>{{ fare.description }}</p>
            </td>
            <td>
                {{ fare.price }} EUR<br>
                <input type=number min=0 max="{{ global_max_per_fare_type }}" class='fare' data-price="{{ fare.price }}" name="{{ fare.code }}" value="{{ fares_info[fare.code] }}">
            </td>
        </tr>
        {% endfor %}
    </table>

    <p>
    TOTAL: <span id="total">{{ calculation.full_price }}</span> EUR
    </p>

    <p>
    Discount code:
    <input type=text name="discount_code" id="discount_code" value="{{ discount_code or ''}}">
    <button name="{{ CartActions.apply_discount_code }}">Apply Discount</button>
    </p>

    {% if discount_code %}
    Discount for `{{ discount_code }}`: <span class='deducted'>- {{ calculation.total_discount }}</span> EUR
    <p id="total_with_discount_paragraph">
    NEW TOTAL amount with <code>{{ discount_code }}</code>: <span id="total_with_discount">{{ calculation.final_price }}</span> EUR
    </p>
    {% endif %}

    <p>
    <input type=submit name="{{ CartActions.buy_tickets }}" value="Confirm order">
    </p>

    {% if request.user.is_staff %}
    <pre>
    Debug:
    Full price (w/o discount): {{ calculation.full_price }} {{ currency }}
    Discount: {{ discount_code }} - {{ calculation.total_discount }} {{ currency }}
    Final price: {{ calculation.final_price }} {{ currency }}
    </pre>
    {% endif %}

</form>


{% endblock %}

{% block javascript %}
<script type="text/javascript">

document.querySelectorAll("form input.fare").forEach((inp) => {
    inp.addEventListener("change", calc)
    inp.addEventListener("keyup", calc)
});

function calc() {
    total = 0

    document.querySelectorAll("form input.fare").forEach((inp) => {
        total += inp.dataset.price * +inp.value
    });

    document.querySelector("#total").textContent = total

    // if we have a discount remove discount calculation (happens serverside)
    // when we recalculate base
    if(document.querySelector("#total_with_discount").textContent) {
        document.querySelector("#total_with_discount_paragraph").style.display = 'none'
    }
}
</script>
{% endblock %}
