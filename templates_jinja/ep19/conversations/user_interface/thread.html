{% extends "ep19/conversations/base.html" %}
{# TODO: different extends #}

{% block breadcrumbs %}
&raquo; <a href='#'>{{ thread.title }}</a>
{% endblock breadcrumbs %}

{% block conversations_content %}
<style type="text/css">
/* temporary style for readability */
div.message {
    border: 1px solid #aaa;
    margin: 1em 0;
    padding: 2em;
    border-radius: 7px;
}

div.message.user_question {
    margin-right: 5em;
}

div.message.staff_reply {
    background: #eee;
    margin-left: 5em;
}
div.message.internal_note {
    background: #f93;
    padding: 1em;
}

div.message.public_note {
    padding: .5em;
    background: #39f;
}
</style>

{{ typography.heading(thread.title, 3, class="mb2") }}

<p>Status: <span class="status-bg-{{ thread.status }}">{{ thread.get_status_display() }}</span></p>
started
<strong title="{{ thread.created }}">{{ timesince(thread.created) }} ago</strong>, last activity
<em title="{{ thread.last_message_date }}">
    {{ timesince(thread.last_message_date) }} ago
</em>

<hr>

{% for message in thread.user_visible_messages() %}
{# TODO: include proper module here #}
<div class='message
{% if not message.is_user_question %}user_question{% endif %}
{% if message.is_staff_reply %}staff_reply{% endif %}
{% if message.is_internal_note %}internal_note{% endif %}
{% if message.is_public_note %}public_note{% endif %}
'>
{{ message.content }}
{% if message.attachments.all() %}
<p>
<strong>Attachments!</strong>
{% for at in message.attachments.all() %}
<a href='{{ at.file.url }}'>{{ at.file.name }}</a><br>
{% endfor %}
{% endif %}

<br>
by <strong>@{{ message.created_by }}</strong> <span title="{{ message.created }}">{{ timesince(message.created) }} ago</span>
</div>
{% endfor %}

<hr>
<h1>Reply to this thread</h1>
<form method='POST' action=".">
    <input type='hidden' name='{{ ThreadActions.submit_reply_to_thread }}'>
    {{ csrf_input }}
    {{ user_reply_form }}
    <input class="text" type="submit" name="" value="Submit reply">
</form>


<hr>
{{ typography.heading("Manage this thread", 5, class="mb2") }}
<form method='POST' action='.'>
    <input type='hidden' name='{{ ThreadActions.submit_thread_management }}'>
    {{ csrf_input }}
    {% if thread.status != thread.STATUS.COMPLETED %}
    <input class="text" type="submit" name="{{ ThreadActions.complete_thread }}" value="Mark as completed">
    {% endif %}

    {% if thread.status == thread.STATUS.COMPLETED %}
    <input class="text" type="submit" name="{{ ThreadActions.reopen_thread }}" value="Reopen">
    {% endif %}
    <a href='#'>
</form>

{% endblock conversations_content %}
