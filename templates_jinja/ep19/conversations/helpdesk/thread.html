{% extends "ep19/conversations/base.html" %}

{% block breadcrumbs %}
{{ super() }}
&raquo; <a href='{{ url("staff_helpdesk:all_threads") }}'>Helpdesk</a>
&raquo; <a href='#'>{{ thread.title }}</a>
{% endblock breadcrumbs %}

{% block conversations_content %}
<style type="text/css">
/* temporary style for readability */
div.message {
    border: 1px solid #aaa;
    margin: 1em 0;
    padding: 2em;
    border-radius: 7px;
}

div.message.user_question {
    margin-right: 5em;
}

div.message.staff_reply {
    background: #eee;
    margin-left: 5em;
}
div.message.internal_note {
    background: #f93;
    padding: 1em;
}

div.message.public_note {
    padding: .5em;
    background: #39f;
}
</style>

{{ typography.heading(thread.title, 3, class="mb2") }}

<p>Status: <span class="status-bg-{{ thread.status }}">{{ thread.get_status_display() }}</span></p>

<form method='POST' action='.'>
    {{ csrf_input }}
    <input type='hidden' name='{{ ThreadActions.change_priority }}'>
    {{ change_priority_form }}
    <input type='submit' value='update priority'>
</form>


started
<strong title="{{ thread.created }}">{{ timesince(thread.created) }} ago</strong>, last activity
<em title="{{ thread.last_message_date }}">
    {{ timesince(thread.last_message_date) }} ago
</em>

{% if thread.metadata %}
    {% include "ep19/conversations/_thread_metadata_as_table.html" %}
{% endif %}


<hr>

{% for message in thread.messages.all() %}
{# TODO: include proper module here #}
<div class='message
{% if not message.is_user_question %}user_question{% endif %}
{% if message.is_staff_reply %}staff_reply{% endif %}
{% if message.is_internal_note %}internal_note{% endif %}
{% if message.is_public_note %}public_note{% endif %}
'>

{{ message.content }}


{% if message.attachments.all() %}
<p>
<strong>Attachments!</strong>
{% for at in message.attachments.all() %}
<a href='{{ at.file.url }}'>{{ at.file.name }}</a><br>
{% endfor %}
{% endif %}

<br>
by <strong>@{{ message.created_by }}</strong> <span title="{{ message.created }}">{{ timesince(message.created) }} ago</span>
</div>
{% endfor %}

<hr>
<h3>Internal note?</h3>
<form method='POST' action=".">
    <input type='hidden' name='{{ ThreadActions.submit_internal_note }}'>
    {{ csrf_input }}
    {{ internal_note_form }}
    <input class="text" type="submit" name="" value="Submit internal note">
</form>


<hr>
{% if thread.status != thread.STATUS.COMPLETED %}
<h1>Reply to this thread</h1>
<form method='POST' action=".">
    <input type='hidden' name='{{ ThreadActions.submit_reply_to_thread }}'>
    {{ csrf_input }}
    <table>
    {{ reply_form.as_table() }}
    </table>
    <input class="text" type="submit" name="" value="Submit reply">
</form>
{% else %}
<p>
You can't reply any more to this thread, as it is marked as completed.
If you really want to reply to this thread, please reopen the thread using button at the bottom of this page.
</p>
{% endif %}


<hr>
{{ typography.heading("Manage this thread", 5, class="mb2") }}
<form method='POST' action='.'>
    <input type='hidden' name='{{ ThreadActions.submit_thread_management }}'>
    {{ csrf_input }}
    {% if thread.status != thread.STATUS.COMPLETED %}
    <input class="text" type="submit" name="{{ ThreadActions.complete_thread }}" value="Mark as completed">
    {% endif %}

    {% if thread.status == thread.STATUS.COMPLETED %}
    <input class="text" type="submit" name="{{ ThreadActions.reopen_thread }}" value="Reopen">
    {% endif %}
    <a href='#'>
</form>

{% endblock conversations_content %}
